generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String      @id @default(uuid())
  email     String      @unique
  username  String      @unique
  password  String
  avatar    String?
  status    UserStatus  @default(OFFLINE)
  lastSeen  DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  messages  Message[]
  channels  ChannelMember[]
  reactions Reaction[]
}

enum UserStatus {
  ONLINE
  OFFLINE
  AWAY
}

model Channel {
  id          String        @id @default(uuid())
  name        String
  description String?
  type        ChannelType   @default(PUBLIC)
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  members     ChannelMember[]
  messages    Message[]
}

enum ChannelType {
  PUBLIC
  PRIVATE
  DIRECT
}

model ChannelMember {
  id        String     @id @default(uuid())
  userId    String
  channelId String
  role      MemberRole @default(MEMBER)
  joinedAt  DateTime   @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
}

enum MemberRole {
  ADMIN
  MODERATOR
  MEMBER
}

model Message {
  id          String     @id @default(uuid())
  content     String
  channelId   String
  senderId    String
  parentId    String?   // for threaded replies
  attachments String[]  // S3 URLs
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  channel   Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sender    User      @relation(fields: [senderId], references: [id])
  parent    Message?  @relation("Thread", fields: [parentId], references: [id])
  replies   Message[] @relation("Thread")
  reactions Reaction[]

  @@index([channelId, createdAt])
}

model Reaction {
  id        String   @id @default(uuid())
  emoji     String
  messageId String
  userId    String
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
}

